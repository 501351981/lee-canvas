var LiCanvas=function(){"use strict";var t="SET_BACKGROUND_COLOR",n="DRAW_BACKGROUND_IMAGE",o="DRAW_IMAGE_TASK",e="DRAW_TEXT_TASK",i=function(t){return Object.prototype.toString.call(t)==Object.prototype.toString.call([])},a=function(t){return Object.prototype.toString.call(t)==Object.prototype.toString.call({})},r=function(t){return Object.prototype.toString.call(t)==Object.prototype.toString.call("a")};function c(t,n,o){var e=new Image;e.setAttribute("crossOrigin","Anonymous"),e.src=n.src,e.onload=function(){n.hasOwnProperty("borderRadius")?function(t,n,o,e,i,a,r){var c=Math.min(r,i/2,a/2);t.ctx.save(),t.ctx.beginPath(),t.ctx.moveTo(o,e+c),t.ctx.arcTo(o,e,o+c,e,c),t.ctx.lineTo(o+i-c,e),t.ctx.arcTo(o+i,e,o+i,e+c,c),t.ctx.lineTo(o+i,e+a-c),t.ctx.arcTo(o+i,e+a,o+i-c,e+a,c),t.ctx.lineTo(o+c,e+a),t.ctx.arcTo(o,e+a,o,e+a-c,c),t.ctx.lineTo(o,e+c),t.ctx.clip(),t.ctx.drawImage(n,o,e,i,a),t.ctx.restore()}(t,e,n.x,n.y,n.width,n.height,n.borderRadius):t.ctx.drawImage(e,n.x,n.y,n.width,n.height),"function"==typeof o&&o.call(t)}}function s(t,n,o){o.hasOwnProperty("x")&&(t.fontStartX=o.x),o.hasOwnProperty("y")&&(t.fontStartY=o.y);var e=void 0;e=o.hasOwnProperty("width")?o.width:"horizontal"==o.textDirection?t.canvasWidth-t.fontStartX:t.canvasHeight-t.fontStartY,t.ctx.font=[o.fontStyle,o.fontWeight,o.fontSize+"px",o.fontFamily].join(" "),t.ctx.fillStyle=o.color,t.ctx.textBaseline="top","horizontal"==o.textDirection?function(t,n,o,e){for(var i="",a=[],r=0;r<n.length;r++)i+=n[r],(t.ctx.measureText(i).width>=o||r==n.length-1)&&(a.push(i),i="");for(var c=0;c<a.length;c++)t.ctx.fillText(a[c],Math.floor(t.fontStartX),Math.floor(t.fontStartY)),c<a.length-1?t.fontStartY+=e.lineHeight:t.fontStartY+=e.fontSize+e.marginBottom}(t,n,e,o):function(t,n,o,e){for(var i="",a=[],r=0;r<n.length;r++)i+=n[r],(t.ctx.measureText(i).width>=o||r==n.length-1)&&(a.push(i),i="");for(var c=0;c<a.length;c++){for(var s=a[c],f=t.fontStartY,l=0;l<s.length;l++)t.ctx.fillText(s[l],Math.floor(t.fontStartX),Math.floor(t.fontStartY)),t.fontStartY+=e.fontSize;t.fontStartY=f,c<a.length-1?"ltr"==e.rowDirection?t.fontStartX+=e.lineHeight:t.fontStartX-=e.lineHeight:"ltr"==e.rowDirection?t.fontStartX+=e.fontSize+e.marginBottom:t.fontStartX-=e.fontSize+e.marginBottom}}(t,n,e,o)}function f(t,n,o){t.tasks.push({type:n,params:o})}var l=new Array;l[o]=function(t,n,o){c(t,n,o)},l[e]=function(t,n,o){!function(t,n){var o=n.text,e=n.style;if(r(o)){var c=Object.assign({},t.fontStyle,e);s(t,o,c)}else if(i(o))o.forEach(function(n,o){if(r(n)){var i=Object.assign({},t.fontStyle,e);s(t,n,i),0==o&&(delete e.x,delete e.y)}else if(a(n)){var c=Object.assign({},t.fontStyle,e,n);s(t,n.text,c),0==o&&(delete e.x,delete e.y)}});else if(a(o)){var f=Object.assign({},t.fontStyle,e,o);s(t,o.text,f)}}(t,n),o()},l[t]=function(t,n,o){!function(t,n,o){var e=n.backgroundColor;t.ctx.fillStyle=e,t.ctx.fillRect(0,0,t.canvasWidth,t.canvasHeight),"function"==typeof o&&o.call(t)}(t,n,o)},l[n]=function(t,n,o){!function(t,n,o){var e=n.backgroundImage,i=n.backgroundRepeat,a=new Image;a.setAttribute("crossOrigin","Anonymous"),a.src=e,a.onload=function(){var n=t.ctx.createPattern(a,i);t.ctx.fillStyle=n,t.ctx.fillRect(0,0,t.canvasWidth,t.canvasHeight),"function"==typeof o&&o.call(t)}}(t,n,o)};var h={backgroundColor:"#ffffff",fontStyle:{x:0,y:0,fontSize:14,fontStyle:"normal",fontWeight:"normal",fontFamily:"PingFangSC-Regular,'Microsoft YaHei',SimSun,Arial,'Helvetica Neue',sans-serif",lineHeight:20,color:"black",marginBottom:10,textDirection:"horizontal",rowDirection:"ltr"},backgroundImage:"",backgroundRepeat:"repeat"};function g(t,n){!function(t,n){var o=document.createElement("a");o.href=n,o.download=t.saveFileName,o.click()}(t,function(t,n){return t.canvas.toDataURL(n)}(t,n=function(t){return"image/"+(t=(t=t.toLowerCase().replace(/jpg/i,"jpeg")).match(/png|jpeg|gif/)[0])}(n)))}function u(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!(this instanceof u))throw new Error("LiCanvas 必须通过new关键词进行实例化");this._init(t,n)}return function(o){o.prototype._init=function(o,e){e.fontStyle=Object.assign({},h.fontStyle,e.fontStyle),this.options=Object.assign({},h,e),this.canvas=document.getElementById(o),this.ctx=this.canvas.getContext("2d"),this.options.width&&(this.canvas.width=this.options.width),this.canvasWidth=this.canvas.width,this.options.height&&(this.canvas.height=this.options.height),this.canvasHeight=this.canvas.height,this.tasks=new Array,this.fontStyle=this.options.fontStyle,this.fontStartX=this.options.fontStyle.x,this.fontStartY=this.options.fontStyle.y,delete this.fontStyle.x,delete this.fontStyle.y,this.options.backgroundColor&&f(this,t,{backgroundColor:this.options.backgroundColor}),this.options.backgroundImage&&f(this,n,{backgroundImage:this.options.backgroundImage,backgroundRepeat:this.options.backgroundRepeat})}}(u),function(e){e.prototype.addDrawImageTask=function(t){var n=this;if(i(t))t.forEach(function(t){f(n,o,t)});else{if(!a(t))throw new Error("addDrawImageTask 参数只支持对象或数组");f(this,o,t)}},e.prototype.addSetBackgroundTask=function(o){var e=o.backgroundColor,i=void 0===e?"":e,a=o.backgroundImage,r=void 0===a?"":a,c=o.backgroundRepeat,s=void 0===c?"repeat":c;i&&f(this,t,{backgroundColor:i}),r&&f(this,n,{backgroundImage:r,backgroundRepeat:s})}}(u),function(t){t.prototype.addDrawTextTask=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};f(this,e,{text:t,style:n})},t.prototype.measureTextWidth=function(t){return function(t,n,o){return t.ctx.font=[o.fontStyle,o.fontWeight,o.fontSize+"px",o.fontFamily].join(" "),t.ctx.measureText(n).width}(this,t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})}}(u),function(t){t.prototype.draw=function(){!function(t,n){0!=t.tasks.length?function o(){var e=t.tasks.shift();e?l[e.type](t,e.params,o):"function"==typeof n&&n()}():"function"==typeof n&&n()}(this,arguments.length>0&&void 0!==arguments[0]?arguments[0]:"")},t.prototype.getImageData=function(){return this.canvas.toDataURL("image/png")},t.prototype.saveToPng=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"lee-canvas";this.saveFileName=t+".png",g(this,"png")},t.prototype.saveToJpeg=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"lee-canvas";this.saveFileName=t+".jpeg",g(this,"jpeg")},t.prototype.saveToGif=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"lee-canvas";this.saveFileName=t+".gif",g(this,"gif")}}(u),u}();
